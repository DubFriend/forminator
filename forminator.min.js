// forminator version 0.0.0
// https://github.com/DubFriend/forminator
// (MIT) 12-03-2014
// Brian Detering <BDeterin@gmail.com> (http://www.briandetering.net/)
!function(){"use strict";!function(a){var b,c=function(b){return a.isArray(b)},d=function(a){return!c(a)&&a instanceof Object},e=function(a){return a instanceof Function},f=function(a,b){for(var c in a)a.hasOwnProperty(c)&&b(a[c],c,a)},g=function(){var a,b={};for(a=0;a<arguments.length;a+=1)f(arguments[a],function(a,c){b[c]=a});return b},h=function(a,b){var d;return c(a)?(d=[],f(a,function(a,c,e){b(a,c,e)&&d.push(a)})):(d={},f(a,function(a,c,e){b(a,c,e)&&(d[c]=a)})),d},i=function(b,c){return a.inArray(c,b)},j=function(a,b){return h(a,function(a,c){return-1===i(b,c)})},k=function(a,b){return function(){(b||function(){}).apply(a,arguments)}},l=function(a){return/\[\]$/.test(a)},m=function(a,b){return a.substring(0,a.length-1)+b+"]"},n=function(b){var c={};return b.each(function(){var b=a(this).attr("name");b&&(c[b]||(c[b]=[]),c[b].push(a(this)))}),c},o=function(){return b.find('input[type="checkbox"], input[type="radio"], input[type="text"], input[type="hidden"], textarea, select')},p=function(a){var b=function(a){var b={};return f(a,function(a,e){!function g(a,e){d(e)||c(e)?f(e,function(b,c){g(a+"["+c+"]",b)}):b[a]=e}(e,a)}),b},e=function(){var a=n(o()),b={},c=function(a,c){var d=function(){return a.is('input[type="checkbox"]')||a.is('input[type="radio"]')},e=function(){return d()?a.is(":checked")?a.val():void 0:a.val()},f=e();(d()&&f||!d())&&(b[c]=f)};return f(a,function(a,b){l(b)?f(a,function(a,d){c(a,m(b,d))}):a.length>1?f(a,function(a){c(a,b)}):c(a[0],b)}),b};return a?b(a):e()},q=function(b){if(b){var c=b.match(/#@#.*#@#/gim);return c&&c[0]?(c=c[0].substring(3,c[0].length-3),c=a.parseJSON(c)):null}return null},r=function(a){return a?a.replace(/#@#.*#@#/gim,""):null},s=function(a,b){b.is('input[type="text"]')||b.is("select")||b.is('input[type="hidden"]')||b.is("textarea")?b.val(a):(b.is('input[type="checkbox"]')||b.is('input[type="radio"]'))&&(""===a||null===a?b.prop("checked",!1):b.filter('[value="'+a+'"]').prop("checked",!0))},t=function(c){c=c||b,c.find('input[type="file"]').each(function(){a(this).wrap("<form>").closest("form").get(0).reset(),a(this).unwrap()})},u=function(c){c=c||!1,o().not('input[type="hidden"]').each(function(){s("",a(this))}),c&&b.find('input[type="hidden"]').each(function(){s("",a(this))}),t()},v=function(a){return e(a)?a.apply({clear:u,clearFileInputs:t,set:function(a,c){s(c,b.find('[name="'+a+'"]'))},get:p},Array.prototype.slice.call(arguments,1)):void 0},w=function(a,b,c){var d=a.response,e=a.metaData,f=e&&e.status||d&&d.status||200;!f||f>=200&&300>f?v(b,d,e):v(c,d,e)},x=function(b,c){var d=q(b);return b=r(b),"json"===c.toLowerCase()&&(b=a.parseJSON(b)),{metaData:d,response:b}},y=function(c){var d=function(){var a=function(a,b){return l(a)?m(a,b):a},c=n(b.find('input[type="file"]')),d={};return f(c,function(b,c){f(b,function(b,e){d[a(c,e)]=b})}),d};b.submit(function(b){console.log("ajax2"),b.preventDefault();var e=A(c());if(!e.validate||e.validate()){var h=new FormData;f(e.data,function(a,b){h.append(b,a)}),f(d(),function(a,b){var c=a[0];c.files.length>0&&(1===c.files.length?h.append(b,c.files[0]):f(c.files,function(a,c){h.append(b+"["+c+"]",a)}))}),a.ajax(j(g(e,{processData:!1,contentType:!1,data:null,type:"POST",dataType:"text",beforeSend:function(a,b){b.xhr=function(){var a=new window.XMLHttpRequest;return a.upload.onprogress=k(this,e.onprogress),a.upload.onload=k(this,e.onload),a.upload.onerror=k(this,e.onerror),a.upload.onabort=k(this,e.onabort),a},b.data=h,v(e.beforeSend)},success:function(a){var b=x(a,e.dataType);w(b,e.success,e.error)},error:function(a){var b=x(a.responseText,e.dataType);v(e.error,b.response,b.metaData)},complete:function(a){var b=x(a.responseText,e.dataType);v(e.complete,b.response,b.metaData)}})),["$files","getData"])}})},z=function(c){b.submit(function(d){d.stopPropagation(),console.log("iframeAjax");var e=A(c());if(!e.validate||e.validate()){var g="file-ajax-id-"+(new Date).getTime();a("body").prepend('<iframe width="0" height="0" style="display:none;" name="'+g+'" id="'+g+'"/>');var h={};o().each(function(){var b=a(this).attr("name");b&&(h[b]=a(this))});var i=function(){f(h,function(a){a.removeAttr("name")})},j=function(){f(h,function(a,b){a.attr("name",b)})},k=a("#"+g);k.on("load",function(){var a=k.contents().find("body").html(),b=x(a,e.dataType);w(b,e.success,e.error),j(),m(),k.remove(),v(e.complete,b.response,b.metaData)}),i();var l=[];f(e.data,function(c,d){var e=a('<input type="hidden" name="'+d+'" value="'+c+'"/>');b.prepend(e),l.push(e)});var m=function(){f(l,function(a){a.remove()})};b.attr({target:g,action:e.url,method:"POST",enctype:"multipart/form-data"})}else d.preventDefault()})},A=function(a){return a.url=a.url||b.attr("action"),a.data=p(a.data),a},B=function(c,d){if(b=a(this),!b.is("form"))throw"selected element must be a form element";a.support.ajax&&"undefined"!=typeof FormData&&d!==!0?y(c):z(c)};B.clearFileInputs=t,a.fn.fileAjax=B,a.fileAjax=B}(jQuery);var a=function(a){return a},b=function(a){return $.isArray(a)},c=function(a){return!b(a)&&a instanceof Object},d=function(a){return a instanceof Function},e=function(a){var b=Array.prototype.slice.call(arguments,1);return d(a)?function(){var c=Array.prototype.slice.call(arguments);return a.apply(null,b.concat(c))}:void 0},f=function(a){var b,c=[];for(b=0;b<a.length;b+=1)c.push(a[b]);return c},g=function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},h=function(a,b){return $.inArray(b,a)},i=function(a,b){return-1!==h(a,b)},j=function(a){return $.extend(!0,{},a)},k=function(a,b){for(var c in a)a.hasOwnProperty(c)&&b(a[c],c,a)},l=function(a){return a[a.length-1]},m=function(a,b){var c=[];return k(a,function(a,d,e){c.push(b(a,d,e))}),c},n=function(a,b,c){var d={};return k(a,function(a,e,f){e=c?c(e,a):e,d[e]=b(a,e,f)}),d},o=function(a,c,d){return b(a)?m(a,c):n(a,c,d)},p=function(a,b,c){return o(a,function(a){return a[b].apply(a,c||[])})},q=function(a){return m(a,function(a,b){return b})},r=function(a,c){var d;return b(a)?(d=[],k(a,function(a,b,e){c(a,b,e)&&d.push(a)})):(d={},k(a,function(a,b,e){c(a,b,e)&&(d[b]=a)})),d},s=function(){var a,b={};for(a=0;a<arguments.length;a+=1)k(arguments[a],function(a,c){b[c]=a});return b},t=function(a,b){return r(a,function(a,c){return-1!==h(b,c)})},u=function(a){var b=Array.prototype.slice.call(arguments,1);return d(a)?a.apply(null,b):void 0},v=(function(){var a=0;return function(){return a+=1}}(),function(a){a=a||{};var b={};return a.publish=function(a,c){k(b[a],function(a){a(c)})},a.subscribe=function(a,c){b[a]=b[a]||[],b[a].push(c)},a.unsubscribe=function(a){k(b,function(b){var c=h(b,a);-1!==c&&b.splice(c,1)})},a}),w=function(){var a={},b=function(a){var b,c,d,e="",f="",g=function(){var b=-1!==h(a,"#"),c=-1!==h(a,"?"),d="";return c&&(d=a.split("?")[1]||"",b&&(d=d.split("#")[0]||"")),e=c?a.split("?")[0]||"":b?a.split("#")[0]||"":a,b&&(f=a.split("#")[1]||""),d?d.split("&"):[]},i=g(a),j={};for(d=0;d<i.length;d+=1)b=i[d].split("=")[0],c=i[d].split("=")[1],j[b]=c;return{url:e||"",hash:f||"",parameters:j}},c=function(a){var b=[];return k(a.parameters,function(c,d){b.push(d+"="+a.parameters[d])}),a.url+(b.length>0?"?"+b.join("&"):"")+(a.hash?"#"+a.hash:"")};return a.get=function(a){return b(a).parameters},a.set=function(a,d){var e=b(a);return e.parameters=s(e.parameters,d),c(e)},a}(),x=function(a,b,c){return $(a+(c?"-"+c:"")+(b?"-"+b:""))},y=e(x,".frm"),z=function(a){var b={},c=a.url,d=a.name,g=a.fieldMap||{},h=e(y,d),i=function(){return o(g,function(a){return a&&a.toHTML})},j=function(){return o(g,function(a){return a&&a.fromHTML})},k=function(a,b){return function(){var c=f(arguments);return b.length?a.apply(null,[b].concat(c)):void 0}};return b.input={text:I,textarea:J,select:H,radio:G,checkbox:E,file:F,button:D,hidden:K},b.form=k(function(d){return O({$:d,ajax:A,validate:a.validate,onprogress:a.onprogress,success:a.success,error:a.error,complete:a.complete,url:c,inputs:o(L({$:d,factory:s(b,{fieldMap:j()})}),function(a){return M({input:a})})})},h("")),b.list=k(function(a){return S({$:a,fieldMap:i()})},h("list")),b.newItemButton=k(function(a){return T({$:a})},h("new")),b.request=function(){return Q({ajax:function(a){$.ajax(a)},url:c})},b.search=k(function(a,c){return P({$:a,request:c,inputs:o(L({$:a,factory:s(b,{fieldMap:j()})}),function(a){return M({input:a})})})},h("search")),b},A=function(b,d){var e=function(){var a=d();return a.type=a.type||"POST",a.dataType=a.dataType?a.dataType.toLowerCase():"json",a},f=function(){var b=e();return b.data=o(b.data||{},a,function(a){return a.replace(/\[\]$/,"")}),b};b.find('input[type="file"]').length?(console.log("$.fn.fileAjax"),b.fileAjax(f,!1)):(console.log("$.ajax"),b.submit(function(a){a.preventDefault();var b=e();b.validate()&&$.ajax({url:b.url,type:b.type,data:b.data,dataType:b.dataType,beforeSend:b.beforeSend,success:function(a){c(a)&&(a.status<200||a.status>=300)?u(b.error,a):u(b.success,a)},error:function(a){u(b.error,"json"===b.dataType?a.responseJSON:a.responseText)},complete:function(a){u(b.complete,"json"===b.dataType?a.responseJSON:a.responseText)}})}))},B=function(a){var b=v(),c=a.$;return b.getType=function(){throw'implement me (return type. "text", "radio", etc.)'},b.$=function(a){return a?c.find(a):c},b.disable=function(){b.$().prop("disabled",!0),b.publish("isEnabled",!1)},b.enable=function(){b.$().prop("disabled",!1),b.publish("isEnabled",!0)},b},C=function(b,c){var d=B(b,c),e=b.fieldMap||a;return d.get=function(){return d.$().val()},d.set=function(a){var b=e(a),c=d.get();c!==b&&(d.$().val(b),d.publish("change",b))},d.clear=function(){d.set("")},c.buildSetter=function(a){return function(b){var c=e(b),f=d.get();f!==c&&(a.call(d,c),d.publish("change",c))}},d},D=function(a){var b={},c=C(a,b);return c.getType=function(){return"button"},c},E=function(a){var c={},d=C(a,c),e=a.fieldMap||function(a){return b(a)?a:o(a.split(","),function(a){return a.replace(/^\s*/,"").replace(/\s*$/,"")})};return d.getType=function(){return"checkbox"},d.get=function(){var a=[];return d.$().filter(":checked").each(function(){$(this).is(":checked")&&a.push($(this).val())}),a},d.set=function(a){var b=e(a),c=d.get(),f=!1;c.length===b.length?k(c,function(a){-1===h(b,a)&&(f=!0)}):f=!0,f&&(d.$().each(function(){$(this).prop("checked",!1)}),k(b,function(a){d.$().filter('[value="'+a+'"]').prop("checked",!0)}),d.publish("change",b))},d.$().click(function(){d.publish("change",d.get())}),d},F=function(a){var b={},c=B(a,b);return c.getType=function(){return"file"},c.get=function(){return l(c.$().val().split("\\"))},c.clear=function(){$.fileAjax.clearFileInputs(c.$().parent())},c.$().change(function(){c.publish("change",c.get())}),c},G=function(a){var b={},c=C(a,b);return c.getType=function(){return"radio"},c.get=function(){return c.$().filter(":checked").val()||null},c.set=b.buildSetter(function(a){a?c.$().filter('[value="'+a+'"]').prop("checked",!0):c.$().prop("checked",!1)}),c.$().change(function(){c.publish("change",c.get())}),c},H=function(a){var b={},c=C(a,b);return c.getType=function(){return"select"},c.$().change(function(){c.publish("change",c.get())}),c},I=function(a){var b={},c=C(a,b);return c.getType=function(){return"text"},c.$().keyup(function(){c.publish("change",c.get())}),c},J=function(a){var b={},c=C(a,b);return c.getType=function(){return"textarea"},c.$().keyup(function(){c.publish("change",c.get())}),c},K=function(a){var b={},c=C(a,b);return c.getType=function(){return"hidden"},c.$().keyup(function(){c.publish("change",c.get())}),c},L=function(a){var b=a.$,c=a.factory,d=a.fieldMap||{},e={},f=function(a,f,g){g=g||e,b.find(f).each(function(){var b=$(this).attr("name");g[b]=c.input[a]({$:$(this),fieldMap:d[b]})})};f("text",'input[type="text"]'),f("textarea","textarea"),f("select","select"),f("file",'input[type="file"]'),f("button",'input[type="button"], input[type="submit"]'),f("hidden",'input[type="hidden"]');var g=function(a,f){var g=[];b.find(f).each(function(){-1===h(g,$(this).attr("name"))&&g.push($(this).attr("name"))}),k(g,function(f){e[f]=c.input[a]({$:b.find('input[name="'+f+'"]'),fieldMap:d[f]})})};return g("radio",'input[type="radio"]'),g("checkbox",'input[type="checkbox"]'),e},M=function(a){var b={},c=a.input,d=c.$().closest(".frm-group");return b.get=c.get||function(){},b.set=c.set||function(){},b.clear=c.clear||function(){},b.disable=c.disable,b.enable=c.enable,b.getType=c.getType,b.$=function(a){return a?d.find(a):d},function(){var a=null,c=!1;b.setFeedback=function(d){c||b.$().addClass("error"),d!==a&&b.$(".frm-feedback").html(d),a=d,c=!0},b.clearFeedback=function(){c&&(b.$().removeClass("error"),b.$(".frm-feedback").html("")),a=null,c=!1}}(),b},N=function(a){var b=v(),d=a.$,e=d.find(".frm-global-feedback"),g=a.inputs;!function(){var a=!1,c=null;b.setGlobalFeedback=function(f){b.clearGlobalSuccess(),a||d.addClass("error"),f!==c&&e.html(f),a=!0,c=f},b.clearGlobalError=function(){a&&d.removeClass("error"),c&&e.html(""),a=!1,c=null}}(),function(){var a=!1,c=null;b.setGlobalSuccess=function(f){b.clearFeedback(),a||d.addClass("success"),f!==c&&e.html(f),a=!0,c=f},b.clearGlobalSuccess=function(){a&&d.removeClass("success"),c&&e.html(""),a=!1,c=null}}(),b.clearGlobalFeedback=function(){b.clearGlobalError(),b.clearGlobalSuccess()},b.setFeedback=function(a){a=a||{},b.clearFeedback(),k(t(g,q(a)),function(b,c){b.setFeedback(a[c])}),b.setGlobalFeedback(a.GLOBAL)},b.clearFeedback=function(){p(g,"clearFeedback"),b.clearGlobalFeedback()},b.disable=function(){p(g,"disable")},b.enable=function(){p(g,"enable")},b.validate=a.validate||function(){return{}};var h=function(){var a=f(arguments);return r(g,function(b){return!i(a,b.getType())})},l=function(){var a=f(arguments);return r(g,function(b){return i(a,b.getType())})};return b.get=function(){return p(h("file","button"),"get")},b.set=function(a,d){c(a)?k(a,function(a,c){b.set(c,a)}):g[a]&&g[a].set(d)},b.clear=function(a){a=a||{};var b=a.isClearHidden?["button"]:["button","hidden"];p(h.apply(null,b),"clear")},function(){var a=b.get();b.reset=function(){p(l("file"),"clear"),b.set(j(a))}}(),b},O=function(a){var b=N(a),c=a.ajax,d=a.url||a.$.attr("action");return b.setAction=function(a){d=w.set(d,{action:a})},c(a.$,function(){return{url:d,dataType:"json",data:b.get(),validate:function(){var a=b.validate(b.get());return g(a)?!0:(b.setFeedback(a),b.publish("error",a),!1)},onprogress:function(b){u(e(a.onprogress,b)),console.log(b.loaded,b.total)},beforeSend:function(){u(a.beforeSend),b.disable(),b.publish("beforeSend")},success:function(c){u(e(a.success,c)),c=c||{},b.setGlobalSuccess(c.successMessage),b.publish("success",c)},error:function(c){u(e(a.error,c)),b.setFeedback(c),b.publish("error",c)},complete:function(c){u(a.complete,c),b.enable(),b.publish("complete",c)}}}),b},P=function(a){var b=N(a),c=a.$,d=a.request;return c.submit(function(a){a.preventDefault(),d.setFilter(b.get()),d.search()}),b},Q=function(c){var d=v(),e=c.ajax,f=c.url,g={},h=function(){var c=o(g||{},a,function(a){return a.replace(/\[\]$/,"")});return w.set(f,r(c,function(a){return b(a)?a.length:a||0===a}))},i=function(a){g=s(g,a)};return d.setOrder=function(c){i(o(c,a,function(a){return"order_"+(b(a)?a.join(","):a)}))},d.setFilter=function(c){i(o(c,a,function(a){return"filter_"+(b(a)?a.join(","):a)}))},d.search=function(){e({type:"GET",url:h(),dataType:"json",success:function(a){d.publish("success",a)},error:function(a){d.publish("error",a.responseJSON)},complete:function(a){d.publish("complete",a.responseJSON)}})},d},R=function(a){var c=v(),d=a.fieldMap||{},e=function(a){return b(a)?a.join(", "):a},f=a.$self,g=function(a){k(a,function(a,b){f.find('[data-field="'+b+'"]').html(d[b]?d[b](a):e(a))})},h=function(){var a=function(a){return/^\[.*\]$/.test(a)?o(a.replace(/^\[/,"").replace(/\]$/,"").split(","),function(a){return a.replace(/^\s*/,"").replace(/\s*$/,"")}):a},b={};return f.find("[data-field]").each(function(){b[$(this).data("field")]=a($(this).data("value"))||""}),b},i=h();return g(i),c.set=function(a){var b=r(a,function(a,b){return"undefined"==typeof i[b]?!1:i[b]!==a});return i=s(i,b),g(b),c},c.hardSet=function(a){c.clear(),c.set(a)},c.clear=function(){return f.find("[data-field]").html(""),f.find("[data-value]").attr("data-value",""),i=o(i,function(){return""}),c},c.destroy=function(){f.remove()},c.get=function(){return j(i)},function(){var a=!1;c.addSelectedClass=function(){a||f.addClass("selected"),a=!0},c.removeSelectedClass=function(){a&&f.removeClass("selected"),a=!1}}(),f.dblclick(function(){c.publish("selected",c)}),c},S=function(a){var b=v(),c=a.fieldMap||{},d=a.$,e=function(){var a=d.find(".frm-list-item:first-child").clone(),b=R({$self:a,fieldMap:c});return b.clear(),a}(),f=function(a){return a.subscribe("selected",function(){p(g,"removeSelectedClass"),a.addSelectedClass(),b.publish("selected",a)}),a},g=function(){var a=[];return d.find(".frm-list-item").each(function(){a.push(f(R({$self:$(this),fieldMap:c})))}),a}();return b.set=function(a){var b=[];k(a,function(a,d){var h;g[d]?g[d].hardSet(a):(h=e.clone(),b.push(h),g[d]=f(R({$self:h,fieldMap:c})),g[d].set(a))}),d.append(b),g.length>a.length&&p(g.splice(a.length,g.length-a.length),"destroy")},b},T=function(a){var b=v(),c=a.$;return c.click(function(){b.publish("click")}),b},U={};U.init=function(a){{var b=z(a),c=b.form(),d=b.list(),e=b.newItemButton(),f=b.request();b.search(f)}return c.setAction("create"),d&&c&&(d.subscribe("selected",function(a){c.set(a.get()),c.setAction("update")}),e&&e.subscribe("click",function(){c.reset(),c.clearFeedback()})),d&&f.subscribe("success",function(a){console.log("request:success",a),d.set(a?a.results:[])}),{form:c,list:d}},window.forminator=U}();